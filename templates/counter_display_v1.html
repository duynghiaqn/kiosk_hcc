<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HCC Counter">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='apple-icon.png') }}">
    <link rel="icon" href="{{ url_for('static', filename='apple-icon.png') }}">
    <title>MÀN HÌNH QUẦY</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" onerror="this.onerror=null; this.href='/static/bootstrap.min.css';">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" onerror="this.onerror=null; this.href='/static/bootstrap-icons.min.css';">
    <style>
        body {
            background-color: #ffc10724;
            color: #333333;
            margin: 0;
            padding: 10px;
            font-family: Arial, sans-serif;
            text-align: center;
            overflow-x: hidden;
        }
        .header {
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .header h1 {
            font-size: 3rem;
            font-weight: bold;
            color: #c00000;
            margin: 0;
        }
        .header img {
            max-height: 60px;
            width: auto;
        }
        .counter-info {
            background-color: #f8f9fa;
            border: 3px solid #c00000;
            border-radius: 8px;
            padding: 20px;
            margin: 0 auto;
            max-width: 800px;
        }
        .counter-info h2 {
            font-size: 4.5rem;
            font-weight: bold;
            color: #c00000;
            margin-bottom: 10px;
			text-transform: uppercase;
        }
        .counter-info p {
            font-size: 3rem;
            margin: 10px 0;
        }
        .blink {
            animation: blink 1s 5; /* Chạy 5 lần */
            animation-fill-mode: forwards; /* Giữ trạng thái cuối */
            font-weight: bold;
        }
        @keyframes blink {
            50% { opacity: 0; font-weight: bold; }
        }
        .no-counter {
            font-size: 3.5rem;
            color: #555555;
            margin: 10px 0;
            font-weight: bold;
        }
        footer {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-top: 2px solid #c00000;
        }
        #currentTime {
            font-size: 2.5rem;
            color: #333333;
            font-weight: 500;
        }
        @media (max-width: 1366px) {
            .header h1 {
                font-size: 3rem;
            }
            .counter-info h2 {
                font-size: 2rem;
            }
            .counter-info p {
                font-size: 2.1rem;
            }
            .no-counter {
                font-size: 2.5rem;
            }
            #currentTime {
                font-size: 2rem;
            }
        }
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            .counter-info h2 {
                font-size: 1.5rem;
            }
            .counter-info p {
                font-size: 2rem;
            }
            .no-counter {
                font-size: 2rem;
            }
            #currentTime {
                font-size: 1.5rem;
            }
        }
        @media (min-width: 3840px) {
            .header h1 {
                font-size: 8vw;
            }
            .counter-info h2 {
                font-size: 4vw;
            }
            .counter-info p {
                font-size: 4vw;
            }
            .no-counter {
                font-size: 4vw;
            }
            #currentTime {
                font-size: 3vw;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
        <h1 id="centerName">TRUNG TÂM PHỤC VỤ HÀNH CHÍNH CÔNG</h1>
    </div>
    <div class="counter-info" id="counterInfo" style="display: none;">
        <h2 id="counterName"></h2>
		<p class="fw-bolder"><span id="counterDescription" class="text-danger"></span></p>
        <p class="text-primary">SỐ ĐANG PHỤC VỤ: <span id="servingNumber" class="text-secondary">---</span></p>
        <p class="text-primary">SỐ KẾ TIẾP: <span id="nextNumber" class="text-secondary">---</span></p>
        <p class="text-dark fs-1">SỐ NGƯỜI CHỜ: <span id="queueLength" class="text-secondary">0</span></p>
    </div>
    <div class="no-counter" id="noCounter" style="display: none;">
        Không có quầy giao dịch nào được cấu hình
    </div>
    <footer>
        <div id="currentTime"></div>
    </footer>
    <audio id="audioPlayer" style="display: none;"></audio>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous" onerror="this.onerror=null; this.src='/static/bootstrap.bundle.min.js';"></script>
    <script>
        // Lấy center_name từ /get_config
        async function loadCenterName() {
            try {
                const response = await fetch('/get_config');
                const data = await response.json();
                document.getElementById('centerName').textContent = data.center_name || 'TRUNG TÂM PHỤC VỤ HÀNH CHÍNH CÔNG';
            } catch (error) {
                console.error('Failed to load center name:', error);
            }
        }

        // Lấy counter_id từ URL
        function getCounterId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        let counterId = getCounterId();
        let previousServingNumber = null;
        let lastRecallTimestamp = null;
        let audioContext = null;
        const audioCache = {};
        const audioDurations = {
            'invite_customer.mp3': 1.0,
            'prefix_number.mp3': 0.4,
            'number_0.mp3': 0.4,
            'number_1.mp3': 0.4,
            'number_2.mp3': 0.4,
            'number_3.mp3': 0.4,
            'number_4.mp3': 0.4,
            'number_5.mp3': 0.4,
            'number_6.mp3': 0.4,
            'number_7.mp3': 0.4,
            'number_8.mp3': 0.4,
            'number_9.mp3': 0.4,
            'please_to_counter.mp3': 1.5,
            'counter_1.mp3': 1.0,
            'counter_2.mp3': 1.0,
            'counter_3.mp3': 1.0,
            'counter_4.mp3': 1.0,
            'counter_5.mp3': 1.0,
            'counter_6.mp3': 1.0,
            'counter_7.mp3': 1.0,
            'counter_8.mp3': 1.0,
            'counter_9.mp3': 1.0,
            'counter_10.mp3': 1.0,
            'counter_11.mp3': 1.0,
            'counter_12.mp3': 1.0
        };
        const playbackRate = 1.2;

        // Cập nhật giờ hiện tại
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('vi-VN', {
                timeZone: 'Asia/Ho_Chi_Minh',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        // Preload file âm thanh
        async function preloadAudioFiles() {
            const files = [
                'invite_customer.mp3',
                'prefix_number.mp3',
                'please_to_counter.mp3',
                ...Array.from({length: 10}, (_, i) => `number_${i}.mp3`),
                ...Array.from({length: 12}, (_, i) => `counter_${i + 1}.mp3`)
            ];
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            for (const file of files) {
                try {
                    const response = await fetch(`/static/audio/${file}`);
                    if (!response.ok) throw new Error(`File ${file} not found`);
                    const arrayBuffer = await response.arrayBuffer();
                    audioCache[file] = await audioContext.decodeAudioData(arrayBuffer);
                } catch (error) {
                    console.warn(`Audio file ${file} not found:`, error);
                }
            }
        }

        // Tạo danh sách file âm thanh cho số thứ tự
        function getNumberAudioFiles(number) {
            if (!number || number === '---') return [];
            const numStr = number.toString().padStart(4, '0');
            const files = [];
            for (const digit of numStr) {
                files.push(`number_${parseInt(digit)}.mp3`);
            }
            return files;
        }

        // Phát âm thanh tuần tự
        async function playAudioSequence(ticketNumber, counterId) {
            if (audioContext) {
                audioContext.close();
            }
            audioContext = new (window.AudioContext || window.webkitAudioContext)();

            const audioFiles = [];
            if (audioCache['invite_customer.mp3']) audioFiles.push('invite_customer.mp3');
            if (audioCache['prefix_number.mp3']) audioFiles.push('prefix_number.mp3');
            for (let digit of ticketNumber) {
                const numberFile = `number_${digit}.mp3`;
                if (audioCache[numberFile]) audioFiles.push(numberFile);
            }
            if (audioCache['please_to_counter.mp3']) audioFiles.push('please_to_counter.mp3');
            const counterFile = `counter_${counterId}.mp3`;
            if (audioCache[counterFile]) audioFiles.push(counterFile);

            if (audioFiles.length === 0) {
                console.warn('Không tìm thấy file âm thanh nào');
                return;
            }

            let currentTime = audioContext.currentTime;
            for (const file of audioFiles) {
                try {
                    const buffer = audioCache[file];
                    if (!buffer) continue;
                    const source = audioContext.createBufferSource();
                    source.buffer = buffer;
                    source.playbackRate.value = playbackRate;
                    source.connect(audioContext.destination);
                    source.start(currentTime);
                    const duration = audioDurations[file] / playbackRate;
                    currentTime += duration + 0.01;
                } catch (error) {
                    console.error(`Error playing ${file}:`, error);
                }
            }

            setTimeout(() => {
                audioContext.close();
                audioContext = null;
            }, (currentTime - audioContext.currentTime) * 1000 + 100);
        }

        // Kiểm tra đăng nhập
        async function checkLogin() {
            try {
                const response = await fetch('/get_status', {
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.status === 401) {
                    window.location.href = '/login';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Error checking login:', error);
                alert('Lỗi kết nối server: ' + error.message);
                return false;
            }
        }

        // Tải thông tin quầy
        async function loadCounterInfo() {
            if (!(await checkLogin())) return;

            if (!counterId) {
                document.getElementById('noCounter').style.display = 'block';
                document.getElementById('counterInfo').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`/get_counter_status/${counterId}`, {
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}: Không thể tải trạng thái quầy`);
                }
                const data = await response.json();
                if (data.error) {
                    document.getElementById('noCounter').style.display = 'block';
                    document.getElementById('noCounter').textContent = data.error;
                    document.getElementById('counterInfo').style.display = 'none';
                    return;
                }

                document.getElementById('noCounter').style.display = 'none';
                document.getElementById('counterInfo').style.display = 'block';
                document.getElementById('counterName').textContent = data.counter_name;
				document.getElementById('counterDescription').textContent = data.counter_description || 'Không có mô tả';
                document.getElementById('counterDescription').className = 'fw-bolder text-success text-uppercase';
                document.getElementById('servingNumber').textContent = data.serving_number;
                document.getElementById('servingNumber').className = data.serving_number !== '---' ? 'fw-bolder text-danger' : 'text-primary';
                document.getElementById('nextNumber').textContent = data.next_number;
                document.getElementById('nextNumber').className = data.next_number !== '---' ? 'blink text-success' : 'text-primary';
                document.getElementById('queueLength').textContent = data.queue_length;
                document.getElementById('queueLength').className = 'text-primary';

                if (data.serving_number !== previousServingNumber && data.serving_number !== '---') {
                    await playAudioSequence(data.serving_number, counterId);
                }
                previousServingNumber = data.serving_number;
            } catch (error) {
                console.error('Error loading counter info:', error);
                document.getElementById('noCounter').style.display = 'block';
                document.getElementById('noCounter').textContent = 'Lỗi tải thông tin quầy';
                document.getElementById('counterInfo').style.display = 'none';
            }
        }

        // Kiểm tra trạng thái gọi lại
        async function checkRecallStatus() {
            try {
                const response = await fetch('/get_recall_status', {
                    headers: { 'Content-Type': 'application/json' }
                });
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                const data = await response.json();
                const recall = data.last_recall;
                if (recall && recall.timestamp !== lastRecallTimestamp && recall.counter_id === counterId) {
                    lastRecallTimestamp = recall.timestamp;
                    await playAudioSequence(recall.ticket_number, counterId);
                }
            } catch (error) {
                console.error('Error checking recall status:', error);
            }
        }

        // Tải lại dữ liệu và cập nhật giờ
        function startAutoRefresh() {
            preloadAudioFiles();
            loadCenterName();
            loadCounterInfo();
            setInterval(loadCounterInfo, 1000);
            updateTime();
            setInterval(updateTime, 1000);
            setInterval(checkRecallStatus, 1000);
        }

        // Tải khi trang mở
        window.onload = function() {
            startAutoRefresh();
        };
    </script>
</body>
</html>